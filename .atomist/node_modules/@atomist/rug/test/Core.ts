import {Project} from "../model/Core"
import {ProjectEditor} from "../operations/ProjectEditor"
import {ProjectGenerator} from "../operations/ProjectGenerator"

/**
 * Result of executing a single test.
 */
export class Result {

    constructor(public result: boolean, public message: string) {}

    static Success: Result = new Result(true, "OK")

    static Failure(why: string): Result {
        return new Result(false, why)
    }
}

interface Definitions {

    Given(s: string, f: (Project, ScenarioWorld?) => void): void

    When(s: string, f: (Project, ScenarioWorld?) => void): void

    Then(s: string, f: (Project, ScenarioWorld?) => Result | boolean): void
    
}

/**
 * Superinterface for all worlds: Isolated contexts
 * available during scenario execution
 */
export interface ScenarioWorld {

    get(key: string): any

    put(key: string, what: any): void

    clear(key: string): void
}

/**
 * Subinterface of ScenarioWorld specific to 
 * scenarios testing project operations
 */
export interface ProjectScenarioWorld extends ScenarioWorld {

    /**
     * Edit the project with the given editor, validating parameters
     */
    editWith(ed: ProjectEditor)

    /**
     * Create a project using the given generator, validating parameters
     */
    generateWith(gen: ProjectGenerator)

    /**
     * How many modifications did editors in this scenario make?
     */
    modificationsMade(): number

    /**
     * Did editing fail?
     */
    failed(): boolean

    /**
     * Did the last operation fail due to invalid parameters?
     * Otherwise null
     */
    invalidParameters(): any

    /**
     * How many editors were run in the execution of this scenario?
     */
    editorsRun(): number
}
 
 // Registered with Nashorn by the test runner
declare var com_atomist_rug_test_gherkin_GherkinRunner$_definitions: Definitions

export function Given(s: string, f: (Project, ScenarioWorld?) => void) { 
    com_atomist_rug_test_gherkin_GherkinRunner$_definitions.Given(s, f) 
}

export function When(s: string, f: (Project, ScenarioWorld?) => void) { 
    com_atomist_rug_test_gherkin_GherkinRunner$_definitions.When(s, f) 
}

export function Then(s: string, f: (Project, ScenarioWorld?) => Result | boolean) { 
    com_atomist_rug_test_gherkin_GherkinRunner$_definitions.Then(s, f) 
}


// Register well-known conditions

Given("an empty project", p => {
    // Nothing to do
})

